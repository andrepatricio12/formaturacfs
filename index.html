<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Convidados CFS2024/2</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #f0f0f0;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background-color: #1e1e1e;
      border-radius: 8px;
    }
    h1, h2 {
      text-align: center;
    }
    input, select, button, label {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      border: none;
    }
    input#matricula {
      width: 50%;
      margin: 0 auto;
      text-align: center;
    }
    button {
      background-color: #4CAF50;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .convidados-list {
      margin-top: 20px;
    }
    .convidado-item {
      display: flex;
      justify-content: space-between;
      padding: 5px;
      background-color: #2b2b2b;
      margin-bottom: 5px;
      border-radius: 4px;
    }
    .admin-access {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <h1>Controle de Convidados CFS2024/2</h1>
    <div id="login-screen">
      <h2>Login</h2>
      <label for="matricula">Matrícula:</label>
      <input type="text" id="matricula" placeholder="Digite sua matrícula" maxlength="10" />
      <button onclick="login()">Entrar</button>
    </div>
    <div id="main-screen" style="display: none;">
      <h2>Olá, <span id="user-name"></span>!</h2>
      <p>Informe o nome dos convidados militares que você deseja convidar.</p>
      <select id="posto">
        <option value="SD">SD</option>
        <option value="CB">CB</option>
        <option value="SGT">SGT</option>
        <option value="ST">ST</option>
        <option value="TEN">TEN</option>
        <option value="CAP">CAP</option>
        <option value="MAJ">MAJ</option>
        <option value="TC">TC</option>
        <option value="CEL">CEL</option>
      </select>
      <input type="text" id="nome-guerra" placeholder="Nome de Guerra" oninput="this.value = this.value.toUpperCase()" />
      <label>
        <input type="checkbox" id="acompanhante" /> Levará acompanhante
      </label>
      <button onclick="adicionarConvidado()">Adicionar Convidado</button>
      <div class="convidados-list" id="meus-convidados">
        <h3>Meus Convidados</h3>
        <ul id="lista-convidados"></ul>
        <p>Total: <span id="contador-convidados">0</span></p>
      </div>
      <div class="admin-access">
        <button onclick="gerarRelatorio()">Relatório</button>
        <div id="relatorio" style="display: none;">
          <h3>Relatório de Convidados</h3>
          <button onclick="exportarCSV()">Exportar CSV</button>
          <ul id="lista-relatorio"></ul>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Configuração do Firebase corrigida
    const firebaseConfig = {
      apiKey: "AIzaSyAZzrttPeX60p_klInzVrL1qeQycYWhf48",
      authDomain: "convites-7dd28.firebaseapp.com",
      projectId: "convites-7dd28",
      storageBucket: "convites-7dd28.appspot.com",
      messagingSenderId: "294544246887",
      appId: "1:294544246887:web:cf3d26af4df0bcff2cecc2",
      measurementId: "G-HGFP0YSMLV"
    };

    // Inicializar Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Simulação de usuários
    const alunos = {
     "9287027": "ELIENAR FARIAS",
        "9306820": "NAZARETH LIMA GOEDERT",
        "9303219": "CARLA DE LUCA LINHARES",
        "9287124": "LEANDRO GHELLERE",
        "9300350": "TIAGO LUIZ CLEMES",
        "9288350": "MARCOS AURÉLIO LUIZ DUARTE",
        "9320547": "ANDRÉ LUIS PATRÍCIO",
        "9288520": "MATHEUS ROSSI LONGO",
        "9320555": "RICARDO MESQUITA DE MEDEIROS",
        "9320601": "JOSÉ RENATO COSTA",
        "9307800": "JEAN CARLOS PEREIRA MACHADO",
        "9300600": "AILTON BOZELLO DE BITTENCOURT",
        "9300341": "TIAGO SANTOS DE SOUZA",
        "9316230": "RODRIGO SILVA DOS SANTOS",
        "9308652": "ANDERSON ROVEDA",
        "9333967": "MAYARA ZILI DA SILVA",
        "9316221": "MARCOS ADRIANO DAL PONT",
        "9333860": "SARAH WAGNER ZANATTA",
        "9329730": "FELIPE LUMERTZ DA SILVA",
        "9316116": "JAQUES ROCHA DE SOUZA",
        "9329340": "ÉZIO FRANCISCO FERNANDES",
        "9329382": "EDERSON FRANÇA DE MACHADO",
        "6606032": "ROBSON GOMES HAHN",
        "9339558": "EVANDRO ANASTÁCIO TEIXEIRA",
        "9339329": "TIAGO ANSELMO VALNIER",
        "9287205": "ALEXANDRE DA LUZ",
        "9307745": "WANDERSON RICARDO DE CARVALHO",
        "9316159": "ANDERSON DOS SANTOS ROSA",
        "9320563": "IURI CÚRCIO CARRER",
        "6718680": "LAURO TOGNON NETO",
        "9330097": "PATRICK CARDOSO DE RAMOS",
        "9330356": "BRUNA DA SILVA PIRES",
        "3847446": "DAIANA PEREIRA",
        "9329056": "VINICIUS JOVELINO COSTA",
        "9339477": "DANIEL SERAFIM PESSI"
    };

    let userMatricula = null;

    function login() {
      const matricula = document.getElementById("matricula").value.trim();
      if (alunos[matricula]) {
        userMatricula = matricula;
        document.getElementById("user-name").innerText = alunos[matricula];
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("main-screen").style.display = "block";
        carregarConvidados();
      } else {
        alert("Matrícula inválida!");
      }
    }

    function adicionarConvidado() {
      const posto = document.getElementById("posto").value;
      const nomeGuerra = document.getElementById("nome-guerra").value.trim();
      const acompanhante = document.getElementById("acompanhante").checked;

      if (!nomeGuerra) {
        alert("Nome de guerra é obrigatório!");
        return;
      }

      const convidado = {
        posto,
        nomeGuerra,
        acompanhante,
        formador: userMatricula,
      };

      db.collection("convidados").add(convidado).then(() => {
        carregarConvidados();
      }).catch((error) => {
        console.error("Erro ao adicionar convidado:", error);
      });
    }

    function carregarConvidados() {
      db.collection("convidados")
        .where("formador", "==", userMatricula)
        .get()
        .then((querySnapshot) => {
          const lista = document.getElementById("lista-convidados");
          lista.innerHTML = "";
          let contador = 0;

          querySnapshot.forEach((doc) => {
            const convidado = doc.data();
            contador += convidado.acompanhante ? 2 : 1;

            const item = document.createElement("li");
            item.innerText = `${convidado.posto} ${convidado.nomeGuerra}`;
            lista.appendChild(item);
          });

          document.getElementById("contador-convidados").innerText = contador;
        }).catch((error) => {
          console.error("Erro ao carregar convidados:", error);
        });
    }

    function gerarRelatorio() {
      db.collection("convidados")
        .get()
        .then((querySnapshot) => {
          const lista = document.getElementById("lista-relatorio");
          lista.innerHTML = "";
          const relatorio = {};

          querySnapshot.forEach((doc) => {
            const { nomeGuerra, formador } = doc.data();
            if (!relatorio[nomeGuerra]) {
              relatorio[nomeGuerra] = { count: 0, formadores: [] };
            }
            relatorio[nomeGuerra].count += 1;
            if (!relatorio[nomeGuerra].formadores.includes(formador)) {
              relatorio[nomeGuerra].formadores.push(formador);
            }
          });

          for (const [nome, data] of Object.entries(relatorio)) {
            const item = document.createElement("li");
            item.innerText = `${nome}: ${data.count} convites (${data.formadores.join(", ")})`;
            lista.appendChild(item);
          }

          document.getElementById("relatorio").style.display = "block";
        });
    }

    function exportarCSV() {
      db.collection("convidados")
        .get()
        .then((querySnapshot) => {
          let csv = "Nome,Convites,Formadores\n";
          const relatorio = {};

          querySnapshot.forEach((doc) => {
            const { nomeGuerra, formador } = doc.data();
            if (!relatorio[nomeGuerra]) {
              relatorio[nomeGuerra] = { count: 0, formadores: [] };
            }
            relatorio[nomeGuerra].count += 1;
            if (!relatorio[nomeGuerra].formadores.includes(formador)) {
              relatorio[nomeGuerra].formadores.push(formador);
            }
          });

          for (const [nome, data] of Object.entries(relatorio)) {
            csv += `${nome},${data.count},${data.formadores.join(";")}\n`;
          }

          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "relatorio_convidados.csv";
          link.click();
          URL.revokeObjectURL(url);
        });
    }
  </script>
</body>
</html>
